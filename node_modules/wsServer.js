var app=require('http').createServer();
var io=require("socket.io")(app);

var PORT=3000;

var clientCount=0;

var socketMap= {};	//存储客户端socket

app.listen(PORT);

var bindListener=function(socket,event){
	console.log(event);
	socket.on(event, function(data) {
    if (socket.clientNum % 2 == 0) {
      if (socketMap[socket.clientNum - 1])
        socketMap[socket.clientNum - 1].emit(event, data);
    } else {
      if (socketMap[socket.clientNum + 1])
        socketMap[socket.clientNum + 1].emit(event, data);
    }
  });
};

io.on("connection",function(socket){
  
  clientCount++;
  socket.clientNum = clientCount;
  socketMap[clientCount]= socket;
  
  if(clientCount % 2 ){
    socket.emit("waiting","waiting for another person");	
  }else{
  	socket.emit("start");
  	socketMap[(clientCount-1)].emit("start");
  }
  
bindListener(socket,"down");
bindListener(socket,"left");
bindListener(socket,"right");
bindListener(socket,"rotate");
bindListener(socket,"fall");

	bindListener(socket,"fixed");
	
	bindListener(socket,"time");
	bindListener(socket,"next");

	bindListener(socket,"add");
	bindListener(socket,"lines");
	
	bindListener(socket,"gameover");
//socket.on("init",function(data){
//	if(socket.clientNum % 2 ){
//		socketMap[socket.clientNum -1].emit("init",data);
//	}else{
//		socketMap[socket.clientNum + 1].emit("init",data);
//	}
//});
  
  socket.on("disconnect",function(){
  	 if (socket.clientNum % 2 == 0) {
      if (socketMap[socket.clientNum - 1])
        socketMap[socket.clientNum - 1].emit('leave');
    } else {
      if (socketMap[socket.clientNum + 1])
        socketMap[socket.clientNum + 1].emit('leave');
    }
    delete(socketMap[socket.clientNum]);
  });
});

console.log("websocket listening on port "+ PORT);
